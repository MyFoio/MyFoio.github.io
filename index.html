<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>foio</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Общие настройки - Material Minimal */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; color: #333; overflow: hidden; }
        
        /* Экран регистрации */
        #reg-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: #fff; display: none; }
        .reg-container { width: 100%; max-width: 300px; margin: 100px auto; text-align: center; padding: 20px; }
        
        /* Плиточные элементы */
        input[type="text"] { width: 100%; border: 2px solid #00A3E0; padding: 12px; font-size: 16px; outline: none; background: #fff; margin-bottom: 10px; }
        button { width: 100%; background: #00A3E0; color: #fff; border: none; padding: 14px; font-size: 14px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        button:active { background: #008fbc; }

        /* Шапка */
        #header { height: 56px; line-height: 56px; background: #00A3E0; color: #fff; font-size: 20px; font-weight: 500; padding: 0 20px; position: absolute; top: 0; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        #header-title { flex-grow: 1; }
        #settings-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0 10px; width: auto; height: auto; text-transform: none; letter-spacing: normal; }
        #settings-btn:active { background: none; }


        /* Область чата */
        #chat-container { position: absolute; top: 56px; bottom: 60px; width: 100%; overflow-y: auto; padding: 10px 0; -webkit-overflow-scrolling: touch; background: #fff; }
        .msg { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; display: table; width: 100%; }
        
        /* Аватарка */
        .avatar { width: 42px; height: 42px; line-height: 42px; text-align: center; color: #fff; font-size: 18px; font-weight: bold; display: table-cell; vertical-align: middle; text-transform: uppercase; }
        
        /* Текст сообщения */
        .msg-body { display: table-cell; vertical-align: top; padding-left: 15px; }
        .nick { font-weight: bold; font-size: 13px; color: #00A3E0; margin-bottom: 2px; }
        .text { font-size: 15px; line-height: 1.4; color: #222; word-break: break-word; }

        /* Нижняя панель ввода */
        #footer { position: absolute; bottom: 0; width: 100%; height: 60px; background: #fff; border-top: 1px solid #ddd; display: table; }
        #input-wrap { display: table-cell; width: 80%; vertical-align: middle; padding-left: 10px; }
        #msg-input { width: 100%; border: none; padding: 10px; font-size: 16px; outline: none; }
        #btn-wrap { display: table-cell; width: 20%; vertical-align: middle; padding: 0 10px; }
        #send-btn { width: 100%; padding: 10px 5px; font-size: 12px; }

        /* Settings Popup */
        #settings-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .settings-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .settings-content h2 {
            margin-top: 0;
            color: #00A3E0;
        }
        .settings-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            text-align: left;
        }
        .settings-content input[type="text"], .settings-content input[type="color"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 15px;
            outline: none;
        }
        .settings-content input[type="color"] {
            height: 40px;
            padding: 0;
            border: none;
            cursor: pointer;
        }
        .settings-content button {
            margin-top: 10px;
            width: calc(100% - 20px);
            max-width: 180px;
            display: inline-block;
            margin: 10px 5px 0 5px;
        }
        .settings-content .btn-close {
            background: #9E9E9E;
        }
        .settings-content .btn-close:active {
            background: #757575;
        }
        .settings-content .btn-delete {
            background: #F44336;
        }
        .settings-content .btn-delete:active {
            background: #D32F2F;
        }

        /* Confirm Popup */
        #confirm-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2001;
            justify-content: center;
            align-items: center;
        }
        .confirm-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 300px;
            text-align: center;
        }
        .confirm-content h3 {
            margin-top: 0;
            color: #00A3E0;
        }
        .confirm-content p {
            margin-bottom: 20px;
            color: #333;
        }
        .confirm-content button {
            width: calc(50% - 10px);
            display: inline-block;
            margin: 0 5px;
        }
        .confirm-content .btn-cancel {
            background: #9E9E9E;
        }
        .confirm-content .btn-cancel:active {
            background: #757575;
        }
    </style>
</head>
<body>
    <div id="reg-screen">
        <div class="reg-container">
            <h1 style="color:#00A3E0; font-size: 48px; margin-bottom: 10px;">foio</h1>
            <p style="margin-bottom: 20px; color: #666;">Enter nickname (latin/numbers)</p>
            <input type="text" id="nick-input" placeholder="Nickname..." maxlength="15">
            <button id="join-btn">Start</button>
        </div>
    </div>

    <div id="main-screen">
        <div id="header">
            <span id="header-title">foio</span>
            <button id="settings-btn">&#9776;</button>
        </div>
        <div id="chat-container"></div>
        <div id="footer">
            <div id="input-wrap">
                <input type="text" id="msg-input" placeholder="Message...">
            </div>
            <div id="btn-wrap">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>

    <div id="settings-popup">
        <div class="settings-content">
            <h2>Settings</h2>
            <label for="new-nick-input">Change Nickname:</label>
            <input type="text" id="new-nick-input" placeholder="New Nickname..." maxlength="15">
            <button id="change-nick-btn">Change Nick</button>

            <label for="avatar-color-picker">Avatar Color:</label>
            <input type="color" id="avatar-color-picker">
            <button id="save-color-btn">Save Color</button>

            <button id="delete-account-btn" class="btn-delete">Delete Account</button>
            <button id="close-settings-btn" class="btn-close">Close</button>
        </div>
    </div>

    <div id="confirm-popup">
        <div class="confirm-content">
            <h3 id="confirm-title">Confirm Action</h3>
            <p id="confirm-message">Are you sure?</p>
            <button id="confirm-yes-btn">Yes</button>
            <button id="confirm-no-btn" class="btn-cancel">No</button>
        </div>
    </div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCAUKnh1wsWSU1gwGxyXetZ5jvFB3YeUOo",
            databaseURL: "https://foio-forum-default-rtdb.firebaseio.com",
            projectId: "foio-forum",
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        var myNick = localStorage.getItem('foio_nick');
        var myAvatarColor = localStorage.getItem('foio_avatar_color') || '#00A3E0'; // Default color
        var currentConfirmAction = null; // To store which action needs confirmation

        if (!myNick) {
            document.getElementById('reg-screen').style.display = 'block';
        } else {
            // Update the settings inputs with current values
            document.getElementById('new-nick-input').value = myNick;
            document.getElementById('avatar-color-picker').value = myAvatarColor;
        }

        // Function to get avatar color, now supports custom color
        function getAvColor(nick) {
            if (nick === myNick && myAvatarColor) {
                return 'background:' + myAvatarColor; // Apply custom color directly
            }
            var sum = 0;
            for (var i = 0; i < nick.length; i++) sum += nick.charCodeAt(i);
            var defaultColors = ['#F44336', '#FFC107', '#4CAF50', '#03A9F4', '#9E9E9E', '#795548', '#9C27B0', '#8BC34A'];
            return 'background:' + defaultColors[sum % defaultColors.length];
        }

        document.getElementById('join-btn').onclick = function() {
            var nick = document.getElementById('nick-input').value.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
            
            if (nick.length < 3) { 
                alert("Min 3 symbols!"); 
                return; 
            }

            var userRef = db.ref('users/' + nick);
            
            userRef.once('value', function(snapshot) {
                if (snapshot.exists()) {
                    alert("This nickname is ALREADY TAKEN!");
                } else {
                    userRef.set({ reg: true, color: '#00A3E0' }, function(error) { // Save default color on reg
                        if (error) {
                            alert("Database Error: Check your Firebase Rules!");
                        } else {
                            localStorage.setItem('foio_nick', nick);
                            localStorage.setItem('foio_avatar_color', '#00A3E0'); // Set default color
                            location.reload();
                        }
                    });
                }
            });
        };

        document.getElementById('send-btn').onclick = sendMessage;
        function sendMessage() {
            var text = document.getElementById('msg-input').value;
            if (!text.trim() || !myNick) return;

            db.ref('messages').push({
                nick: myNick,
                text: text,
                time: Date.now(),
                color: myAvatarColor // Send avatar color with message
            });
            document.getElementById('msg-input').value = "";
        }

        db.ref('messages').limitToLast(50).on('child_added', function(snap) {
            var m = snap.val();
            var chat = document.getElementById('chat-container');
            var msgDiv = document.createElement('div');
            msgDiv.className = 'msg';
            
            var avatarStyle = 'background:' + (m.nick === myNick ? myAvatarColor : (m.color || getAvColor(m.nick).replace('background:', ''))); // Use message color or default
            
            msgDiv.innerHTML = '<div class="avatar" style="' + avatarStyle + '">' + m.nick.charAt(0) + '</div>' +
                               '<div class="msg-body">' +
                               '<div class="nick">' + m.nick + '</div>' +
                               '<div class="text">' + m.text + '</div>' +
                               '</div>';
            
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        });

        document.getElementById('msg-input').onkeypress = function(e) {
            if (e.keyCode == 13) sendMessage();
        };

        // Settings functionality
        document.getElementById('settings-btn').onclick = function() {
            document.getElementById('settings-popup').style.display = 'flex';
            document.getElementById('new-nick-input').value = myNick;
            document.getElementById('avatar-color-picker').value = localStorage.getItem('foio_avatar_color') || '#00A3E0';
        };

        document.getElementById('close-settings-btn').onclick = function() {
            document.getElementById('settings-popup').style.display = 'none';
        };

        document.getElementById('save-color-btn').onclick = function() {
            var newColor = document.getElementById('avatar-color-picker').value;
            localStorage.setItem('foio_avatar_color', newColor);
            myAvatarColor = newColor; // Update global variable
            // Optionally, visually update existing messages from this user without reloading
            var myMessages = document.querySelectorAll('.msg .avatar');
            for (var i = 0; i < myMessages.length; i++) {
                // This is a simple approach, better would be to re-render or selectively update
                // For simplicity, we just update the style if the message's nick matches myNick's initial
                if (myMessages[i].textContent.toLowerCase() === myNick.charAt(0).toLowerCase()) {
                     // This is a heuristic. A more robust solution would involve checking the actual nick
                     // associated with the message, which isn't directly available from this DOM element.
                     // For the given structure and "simplicity" requirement, this is a compromise.
                    myMessages[i].style.background = newColor;
                }
            }
            alert('Avatar color saved!');
            document.getElementById('settings-popup').style.display = 'none';
        };

        document.getElementById('change-nick-btn').onclick = function() {
            var newNick = document.getElementById('new-nick-input').value.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
            
            if (newNick.length < 3) { 
                alert("New nickname must be at least 3 symbols!"); 
                return; 
            }
            if (newNick === myNick) {
                alert("New nickname is the same as current!");
                return;
            }

            var userRef = db.ref('users/' + newNick);
            userRef.once('value', function(snapshot) {
                if (snapshot.exists()) {
                    alert("This new nickname is ALREADY TAKEN!");
                } else {
                    // Start confirmation process
                    showConfirmPopup("Change Nickname", "Are you sure you want to change your nickname from '" + myNick + "' to '" + newNick + "'?", function() {
                        // User confirmed
                        // Remove old nick and add new one
                        db.ref('users/' + myNick).remove(function(error) {
                            if (error) {
                                alert("Failed to remove old nickname: " + error.message);
                            } else {
                                db.ref('users/' + newNick).set({ reg: true, color: myAvatarColor }, function(error) {
                                    if (error) {
                                        alert("Failed to set new nickname: " + error.message);
                                    } else {
                                        localStorage.setItem('foio_nick', newNick);
                                        location.reload(); // Reload to apply new nick
                                    }
                            });
                            }
                        });
                    });
                }
            });
        };

        document.getElementById('delete-account-btn').onclick = function() {
            showConfirmPopup("Delete Account", "Are you absolutely sure you want to delete your account? This action cannot be undone.", function() {
                showConfirmPopup("Final Confirmation", "Really delete '" + myNick + "'? All your messages will remain, but you won't be able to use this nick again.", function() {
                    // User confirmed twice
                    db.ref('users/' + myNick).remove(function(error) {
                        if (error) {
                            alert("Failed to delete account: " + error.message);
                        } else {
                            localStorage.removeItem('foio_nick');
                            localStorage.removeItem('foio_avatar_color');
                            alert('Your account has been deleted!');
                            location.reload(); // Reload to registration screen
                        }
                    });
                });
            });
        };

        // Universal confirmation popup
        function showConfirmPopup(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-popup').style.display = 'flex';
            currentConfirmAction = onConfirm;
        }

        document.getElementById('confirm-yes-btn').onclick = function() {
            document.getElementById('confirm-popup').style.display = 'none';
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            currentConfirmAction = null;
        };

        document.getElementById('confirm-no-btn').onclick = function() {
            document.getElementById('confirm-popup').style.display = 'none';
            currentConfirmAction = null;
        };
    </script>
</body>
</html>
